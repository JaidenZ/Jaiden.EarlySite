
@{
    Layout = null;
}

<div class="modal-dialog receipemodal" role="document">
    <div class="Modal-inner">
        <h3 class="Modal-title">创建门店</h3>
        <div class="Modal-subtitle"></div>
        <div class="Modal-content">
            <div class="QuestionAsk">
                <form novalidate="">
                    <!--名称-->
                    <div class="QuestionAsk-section">
                        <div class="QuestionAsk-title">
                            <div class="Popover">
                                <div class="Input-wrapper Input-wrapper--spread Input-wrapper--large">
                                    <input id="generate_shopname" autocomplete="off" class="Input" placeholder="门店名称" value="" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--地图设置-->
                    <div class="QuestionAsk-section">
                        <div class="QuestionAsk-title">
                            <div class="Popover">
                                <div id="mapContainer" class="Input-wrapper Input-wrapper--spread Input-wrapper--multiline Input-wrapper--large" style="height:0px;padding-bottom:80%">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--门店描述-->
                    <div class="QuestionAsk-section">
                        <div class="QuestionAsk-title">
                            <div class="Popover">
                                <div class="Input-wrapper Input-wrapper--spread Input-wrapper--multiline Input-wrapper--large">
                                    <textarea id="generate_shop_des" rows="2" autocomplete="off" class="Input" placeholder="门店描述"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ModalButtonGroup QuestionAsk-buttonGroup ModalButtonGroup--vertical">
                        <button class="Button Button--primary Button--red" type="button" id="shopbtn_commit">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <button type="button" class="Button Button--plain Modal-closeButton" aria-label="关闭" data-dismiss="modal">
        <svg class="modal-closeIcon" fill="#fff" viewBox="0 0 24 24" width="24" height="24"><path d="M13.486 12l5.208-5.207a1.048 1.048 0 0 0-.006-1.483 1.046 1.046 0 0 0-1.482-.005L12 10.514 6.793 5.305a1.048 1.048 0 0 0-1.483.005 1.046 1.046 0 0 0-.005 1.483L10.514 12l-5.208 5.207a1.048 1.048 0 0 0 .006 1.483 1.046 1.046 0 0 0 1.482.005L12 13.486l5.207 5.208a1.048 1.048 0 0 0 1.483-.006 1.046 1.046 0 0 0 .005-1.482L13.486 12z" fill-rule="evenodd"></path></svg>
    </button>
</div><!-- /.modal-dialog -->

<div id="markicon" hidden="hidden">
    <div class="MakerIcon">
        <div class="MakerIcon-svg">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="32px" height="37px" viewBox="0 0 32 37" enable-background="new 0 0 32 37" xml:space="preserve">
            <image id="image0" width="32" height="37" x="0" y="0" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAlCAMAAAAUaRt1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABU1BMVEVERER+VfxERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERGRkZCQkJDQ0NEREQ/Pz84ODhFRUVcTI10Ut1+Vfw3NzdBQUH///+MZ/y1nf3Lu/7Esf6hg/24of36+f/r5f/k2/739f+Sb/yGX/zi2f78+//Cr/7Yy/7It/65o/2tk/308f/x7f+AWfKbe/2ihf2wl/2HYvKfgvV9VfHHtf7h1/7Rw/7bz/79/f+Vc/3w6/+BW/KLaPOrkvbQwf7u6f+7pf328//k3Px7U/Gzm/3Zzf7Wyf7q4/+8p/2cff2vlf2ymf3c0f7Ov/6AV/zl3f6/q/57UvGqj/2Qbfzo4f7Kuf6ni/3e0/6HYfxAQEA5OTlhTKPC4584AAAAIHRSTlMAAAEEBwwPEhMFCxshJCYVIy00ODk6Ki4zFBgfJzAyFlZFILoAAAABYktHRCy63XGrAAAAB3RJTUUH4ggCDTonhVprIgAAAhJJREFUOMt9lOlX2kAUxYdASAgJAhFRBOlkRB15LZGlrWApttVWhba2avcN6WIXm///U9+EBE1ZLgfOnPd+85KZcy+ESOGIHFXUMSlRORKWCJFimhrXjcSYDD2uajGJhLW5ZCptTlA6lZzTwiSiJs0b1KLMohZjzPKEy9WSmVQjRI6n1tY3+ARtrG+m4jKJ6mk6sY9EOa1HiWKYFp+iNdNQiJow2TTAMhPqTIB5gMUBP0I3b1Uq9pa7tAGuTfCAag3qjdvQuINrGAfubjft1k7jXrtRuz8R2OlUd7H8gEOl+dAFgu/wCPZg/zGW+ZODw8PABLwHLB9td/F3H7/Qq8JTOzBBAM/snnjT57gVWrU9PMZ/E5otOEbghQBenpyKWhA4a8GrY4DX4ogHZ2+uA8wF3r57LzaL+4AP8HF8wqfmZx/40q+fjwPng8bXngC+1dvwXcwZnWL4CP5j96Td7cCF/RNaPAAMJ+BdH8FF3+52Or/4EPAfQT2A863+YPD79A/nwQl0pmHQcjMMg5ZD017ONC3a/u8021NhexGczVXMCXOueo7FLEapGxwvevOZjDUiHJrJzPvR88O7kF30CYctZhdG4fXiv5RbzheoM9xfyC/nlvz4C4VCISkm54xsGQnnMmvk5JiEReIr5BOFsuOUC37/CnAliMRKqbSSEH0yQUgU9XxeL07pu/9GSrGoaIH+P1kOlu2G3pFFAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTA4LTAyVDEzOjU4OjM5KzA4OjAw0d1K+AAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0wOC0wMlQxMzo1ODozOSswODowMKCA8kQAAABDdEVYdHNvZnR3YXJlAC91c3IvbG9jYWwvaW1hZ2VtYWdpY2svc2hhcmUvZG9jL0ltYWdlTWFnaWNrLTcvL2luZGV4Lmh0bWy9tXkKAAAAGHRFWHRUaHVtYjo6RG9jdW1lbnQ6OlBhZ2VzADGn/7svAAAAF3RFWHRUaHVtYjo6SW1hZ2U6OkhlaWdodAAzN1ieDHsAAAAWdEVYdFRodW1iOjpJbWFnZTo6V2lkdGgAMzLQWzh5AAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADEzMTEwNzkxOTLTYxLOAAAAEXRFWHRUaHVtYjo6U2l6ZQAxMzM3QsF2S7AAAABgdEVYdFRodW1iOjpVUkkAZmlsZTovLy9ob21lL3d3d3Jvb3QvbmV3c2l0ZS93d3cuZWFzeWljb24ubmV0L2Nkbi1pbWcuZWFzeWljb24uY24vc3JjLzU1MzQvNTUzNDYzLnBuZ7wnzuQAAAAASUVORK5CYII=" />

            </svg>
        </div>
        <span class="MakerIcon-lable" id="markicontitle">测试商家</span>
    </div>
</div>

<script type="text/javascript">

    var marker = null;
    var markerlnglat = null;

    var scale = new AMap.Scale({
        visible: false
    }),
        toolBar = new AMap.ToolBar({
            visible: false
        }),
        overView = new AMap.OverView({
            visible: false
        }),
        map = new AMap.Map("mapContainer", {
            resizeEnable: true
        });
    map.addControl(scale);
    map.addControl(toolBar);
    map.addControl(overView);
    var geolocation;

    map.plugin('AMap.Geolocation', function () {
        geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,//是否使用高精度定位，默认:true
            timeout: 10000,          //超过10秒后停止定位，默认：无穷大
            buttonOffset: new AMap.Pixel(-40, -40),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
            zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
            buttonPosition: 'RB'
        });
        map.addControl(geolocation);
        geolocation.getCurrentPosition();
        AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
        AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
    });


    //右键点击 选中目标创建标记
    map.on('rightclick', function (e) {

        //获取门店名称
        var shopname = $("#generate_shopname").val();
        if (shopname == null || shopname == "" || shopname == undefined) {
            toast('请先输入门店名称');
            return;
        }
        markerlnglat = e.lnglat;
        setmarker(shopname, markerlnglat.lng, markerlnglat.lat);
        $("#mapContainer").attr("data-lng", markerlnglat.lng);
        $("#mapContainer").attr("data-lat", markerlnglat.lat);
    });

    //在地图上设置标注
    function setmarker(markertitle,lng,lat) {
        if (marker != null || marker != undefined) {
            map.remove(marker);
        }
        $("#markicontitle").html(markertitle);
        var content = $("#markicon").html();
        marker = new AMap.Marker({
            content: content,
            position: new AMap.LngLat(lng,lat),   // 经纬度对象，也可以是经纬度构成的一维数组[116.39, 39.9]
            title: markertitle,
            offset: new AMap.Pixel(-40, -85) // 相对于基点的偏移位置
        });

        map.add(marker);
    }

    //解析定位结果
    function onComplete(data) {

        var str = ['定位成功'];
        str.push('经度：' + data.position.getLng());
        str.push('纬度：' + data.position.getLat());
        if (data.accuracy) {
            str.push('精度：' + data.accuracy + ' 米');
        }//如为IP精确定位结果则没有精度信息
        str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
        console.log(str);
    }

    //解析定位错误信息
    function onError(data) {
        console.log('定位失败');
    }

    map.on('complete', function () {
        $('.amap-logo').css('visibility', 'hidden');
        $('.amap - copyright').css('visibility', 'hidden');
    });


</script>

<script>
    $(function () {
        //渲染焦点效果
        $('.Input').on('focus', function () {
            $(this).parent().addClass('is-focus');
        });
        $('.Input').on('blur', function () {
            $(this).parent().removeClass('is-focus');
        });

        //门店名称改变时
        $("#generate_shopname").on("change", function () {
            var title = $("#generate_shopname").val();
            if (markerlnglat != null || markerlnglat != undefined) {
                setmarker(title, markerlnglat.lng, markerlnglat.lat);
            }
        });


        //提交
        $("#shopbtn_commit").click(function () {

            //数据验证
            var shopname = $('#generate_shopname').val();
            if (shopname == null || shopname == "") {
                toast("请填上门店的名字！");
                return;
            }
            var longitude = $("#mapContainer").attr("data-lng");
            var latitude = $("#mapContainer").attr("data-lat");

            if (longitude == 0 || longitude == null || longitude == undefined || latitude == 0 || latitude == null || latitude == undefined) {
                toast("请在地图上选择门店的地址进行定位！");
                return;
            }

            //禁用提交按钮 防止重复提交
            var _this = $(this);
            _this.prop('disabled', true);

            var shop = {};
            shop.Longitude = longitude;
            shop.Latitude = latitude;
            shop.ShopName = shopname;
            shop.Description = $('#generate_shop_des').val();

            $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: '@Url.Action("GenerateShop", "Component")',
                    data: {
                        shop: shop
                    },
                    success: function (data) {
                        console.log(data);
                        //启用提交按钮
                        _this.prop('disabled', false);
                        if (data.Status) {
                            toast(data.Message);
                            setTimeout(function () {
                                window.location.reload();
                            }, 1000);
                        }
                        else {
                            toast(data.Message);
                        }
                    },
                    error: function (error) {
                        toast("Ajax send error");
                    }
            });
        });
    });

</script>