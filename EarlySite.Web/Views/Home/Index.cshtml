@using EarlySite.Model.Show;
@using EarlySite.Model.Common;
@using EarlySite.Model.Enum;

@{
    ViewBag.Title = "首页";
}
<div class="header-banner">
    <a href="https://www.bilibili.com/blackboard/join-list.html" target="_blank" class="banner-href"></a>

</div>

<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <div id="mapContainer" class="row corner" style="height:0px;padding-bottom:40%">
            </div>
        </div>
    </div>
    <div class="row corner">
        <div class="warrper">
            <div class="warrper-header">
                <a class="warrper-header-title efont" href="">今日食</a>
            </div>
            <div class="warrper-body">
                @{
                    Html.RenderPartial("TodayDishPartialView");
                }
            </div>
        </div>


    </div>



    <div class="row corner">

        <div class="warrper">
            <div class="warrper-header">
                <a class="warrper-header-title efont" href="">推荐单品</a>
                <span class="warrper-header-more"><a href="" class="efont">更多</a></span>
            </div>
            <div class="warrper-body">
                @{
                    Html.RenderPartial("PushDishInfoPartialView", (PageList<Dish>)ViewBag.DishList);
                }
            </div>
        </div>

        <div class="warrper">
            <div class="warrper-header">
                <a class="warrper-header-title efont" href="">推荐食谱</a>
                <span class="warrper-header-more"><a href="" class="efont">更多</a></span>
            </div>
            <div class="warrper-body">
                @{
                    Html.RenderPartial("PushRecipesInfoPartialView", (PageList<Recipes>)ViewBag.RecipesList);
                }
            </div>
        </div>
    </div>


</div>

<div id="markicon" hidden="hidden">
    <div class="MakerIcon">
        <div class="MakerIcon-svg">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve" width="30px" height="30px">
            <path style="fill:#B9785F;" d="M494.345,463.448H17.655V48.552c0-4.875,3.953-8.828,8.828-8.828h459.034
        c4.875,0,8.828,3.953,8.828,8.828V463.448z" />







            <path style="fill:#AA6455;" d="M494.345,180.205c-1.809,0.45-3.67,0.76-5.618,0.76c-12.853,0-23.273-10.42-23.273-23.273
        c0,12.852-10.42,23.273-23.273,23.273c-12.853,0-23.273-10.42-23.273-23.273c0,12.852-10.419,23.273-23.273,23.273
        c-12.853,0-23.273-10.42-23.273-23.273c0,12.852-10.42,23.273-23.273,23.273s-23.273-10.42-23.273-23.273
        c0,12.852-10.42,23.273-23.273,23.273c-12.853,0-23.273-10.42-23.273-23.273c0,12.852-10.419,23.273-23.273,23.273
        s-23.273-10.42-23.273-23.273c0,12.852-10.42,23.273-23.273,23.273c-12.853,0-23.273-10.42-23.273-23.273
        c0,12.852-10.419,23.273-23.273,23.273c-12.853,0-23.273-10.42-23.273-23.273c0,12.852-10.42,23.273-23.273,23.273
        c-12.853,0-23.273-10.42-23.273-23.273c0,12.852-10.42,23.273-23.273,23.273s-23.273-10.42-23.273-23.273
        c0,12.852-10.419,23.273-23.273,23.273c-1.948,0-3.809-0.31-5.618-0.76v17.848c1.854,0.257,3.694,0.568,5.618,0.568
        c8.639,0,16.661-2.69,23.273-7.277c6.614,4.586,14.635,7.276,23.275,7.276c8.639,0,16.661-2.69,23.273-7.277
        c6.612,4.587,14.634,7.277,23.273,7.277s16.661-2.69,23.273-7.277c6.612,4.587,14.634,7.277,23.273,7.277
        c8.639,0,16.661-2.69,23.273-7.277c6.612,4.587,14.634,7.277,23.273,7.277c8.639,0,16.661-2.69,23.273-7.277
        c6.611,4.587,14.633,7.277,23.272,7.277s16.661-2.69,23.273-7.277c6.612,4.587,14.634,7.277,23.273,7.277
        c8.639,0,16.661-2.69,23.273-7.277c6.612,4.587,14.634,7.277,23.273,7.277c8.639,0,16.661-2.69,23.273-7.277
        c6.612,4.587,14.634,7.277,23.273,7.277s16.661-2.69,23.273-7.277c6.612,4.587,14.634,7.277,23.273,7.277
        c8.64,0,16.661-2.69,23.273-7.277c6.612,4.587,14.634,7.277,23.273,7.277c1.923,0,3.764-0.31,5.618-0.568v-17.847H494.345z" />















            <rect x="61.793" y="216.276" style="fill:#B4E1FA;" width="247.172" height="158.897" />















            <polygon style="fill:#DAF0FD;" points="264.828,366.345 247.172,366.345 141.241,225.103 158.897,225.103 " />















            <g>
            <path style="fill:#D2555A;" d="M209.454,180.966L209.454,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C232.727,170.546,222.307,180.966,209.454,180.966z" />















            <path style="fill:#D2555A;" d="M302.546,180.966L302.546,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C325.818,170.546,315.399,180.966,302.546,180.966z" />















            <path style="fill:#D2555A;" d="M116.364,180.966L116.364,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C139.636,170.546,129.217,180.966,116.364,180.966z" />















            <path style="fill:#D2555A;" d="M23.273,180.966L23.273,180.966C10.42,180.966,0,170.546,0,157.693v-20.865h46.546v20.865
            C46.546,170.546,36.126,180.966,23.273,180.966z" />















            <path style="fill:#D2555A;" d="M395.636,180.966L395.636,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C418.909,170.546,408.49,180.966,395.636,180.966z" />















    </g>
            <g>
            <path style="fill:#C7CFE2;" d="M162.909,180.966L162.909,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C186.182,170.546,175.763,180.966,162.909,180.966z" />















            <path style="fill:#C7CFE2;" d="M349.091,180.966L349.091,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C372.363,170.546,361.944,180.966,349.091,180.966z" />















    </g>
            <path style="fill:#D2555A;" d="M488.727,180.966L488.727,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865H512v20.865
        C512,170.546,501.58,180.966,488.727,180.966z" />















            <g>
            <path style="fill:#C7CFE2;" d="M442.182,180.966L442.182,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C465.454,170.546,455.034,180.966,442.182,180.966z" />















            <path style="fill:#C7CFE2;" d="M69.818,180.966L69.818,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C93.091,170.546,82.671,180.966,69.818,180.966z" />















            <path style="fill:#C7CFE2;" d="M256,180.966L256,180.966c-12.853,0-23.273-10.42-23.273-23.273v-20.865h46.546v20.865
            C279.273,170.546,268.853,180.966,256,180.966z" />















    </g>
            <g>
            <polygon style="fill:#FF6464;" points="232.727,136.828 186.182,136.828 190.997,66.207 234.333,66.207 	" />















            <polygon style="fill:#FF6464;" points="325.818,136.828 279.273,136.828 277.667,66.207 321.003,66.207 	" />















            <polygon style="fill:#FF6464;" points="139.636,136.828 93.091,136.828 104.326,66.207 147.661,66.207 	" />















            <polygon style="fill:#FF6464;" points="46.546,136.828 0,136.828 17.655,66.207 60.991,66.207 	" />















            <polygon style="fill:#FF6464;" points="418.909,136.828 372.363,136.828 364.339,66.207 407.673,66.207 	" />















    </g>
            <g>
            <polygon style="fill:#EFF2FA;" points="186.182,136.828 139.636,136.828 147.661,66.207 190.997,66.207 	" />















            <polygon style="fill:#EFF2FA;" points="372.363,136.828 325.818,136.828 321.003,66.207 364.339,66.207 	" />















    </g>
            <polygon style="fill:#FF6464;" points="512,136.828 465.454,136.828 451.009,66.207 494.345,66.207 " />















            <g>
            <polygon style="fill:#EFF2FA;" points="465.454,136.828 418.909,136.828 407.673,66.207 451.009,66.207 	" />















            <polygon style="fill:#EFF2FA;" points="93.091,136.828 46.546,136.828 60.991,66.207 104.326,66.207 	" />















            <polygon style="fill:#EFF2FA;" points="279.273,136.828 232.727,136.828 234.333,66.207 277.667,66.207 	" />















    </g>
            <path style="fill:#C7CFE2;" d="M503.172,472.276H8.828c-4.875,0-8.828-3.953-8.828-8.828l0,0c0-4.875,3.953-8.828,8.828-8.828
        h494.345c4.875,0,8.828,3.953,8.828,8.828l0,0C512,468.323,508.047,472.276,503.172,472.276z" />















            <g style="opacity:0.97;">
            <rect x="17.655" y="436.966" style="fill:#AFB9D2;" width="476.69" height="17.655" />















    </g>
            <rect x="17.655" y="401.655" style="fill:#AA6455;" width="476.69" height="35.31" />















            <g>
            <path style="fill:#5B5D6E;" d="M300.138,225.103v141.241H70.621V225.103H300.138 M308.966,207.448H61.793
            c-4.875,0-8.828,3.953-8.828,8.828v158.897c0,4.875,3.953,8.828,8.828,8.828h247.172c4.875,0,8.828-3.953,8.828-8.828V216.276
            C317.793,211.401,313.841,207.448,308.966,207.448L308.966,207.448z" />















            <path style="fill:#5B5D6E;" d="M450.207,207.448h-88.276c-4.875,0-8.828,3.953-8.828,8.828v220.69h105.931v-220.69
            C459.034,211.401,455.082,207.448,450.207,207.448z" />















    </g>
            <rect x="370.759" y="225.103" style="fill:#B4E1FA;" width="70.621" height="141.241" />















            <rect x="70.621" y="225.103" style="fill:#A0D2F0;" width="229.517" height="17.655" />















            <rect id="SVGCleanerId_0" x="370.759" y="225.103" style="fill:#A0D2F0;" width="70.621" height="17.655" />















            <polygon style="fill:#A0D2F0;" points="229.517,366.345 194.207,366.345 88.276,225.103 123.586,225.103 " />















            <polygon style="fill:#B4E1FA;" points="172.138,242.759 158.897,225.103 141.241,225.103 154.483,242.759 " />















            <polygon style="fill:#DAF0FD;" points="441.379,295.724 388.414,225.103 370.759,225.103 441.379,319.265 " />















            <polygon style="fill:#B4E1FA;" points="401.655,242.759 388.414,225.103 370.759,225.103 384,242.759 " />















            <g>
            <rect id="SVGCleanerId_0_1_" x="370.759" y="225.103" style="fill:#A0D2F0;" width="70.621" height="17.655" />















    </g>
            <polygon style="fill:#DAF0FD;" points="441.379,295.724 388.414,225.103 370.759,225.103 441.379,319.265 " />















            <polygon style="fill:#A0D2F0;" points="370.759,248.644 370.759,295.724 423.724,366.345 441.379,366.345 441.379,342.804 " />















            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
            <g>
    </g>
    </svg>
        </div>
        <span class="MakerIcon-lable" id="markicontitle">测试商家</span>

    </div>

</div>


@section scripts
{

    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="http://webapi.amap.com/maps?v=1.4.3&key=e024f773e61e96be65e2e8a4f0869774&&plugin=AMap.Scale,AMap.OverView,AMap.ToolBar"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    <script type="text/javascript">

        //店铺标记集合
        var shopmakerlist = [];
        //地图显示图层
        var features = [];

        var scale = new AMap.Scale({
            visible: false
        }),
            toolBar = new AMap.ToolBar({
                visible: false
            }),
            overView = new AMap.OverView({
                visible: false
            }),
            map = new AMap.Map("mapContainer", {
                resizeEnable: true
            });

        features.push("bg");
        features.push("road");

        map.setFeatures(features);
        map.addControl(scale);
        map.addControl(toolBar);
        map.addControl(overView);
        var geolocation;

        map.plugin('AMap.Geolocation', function () {
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,//是否使用高精度定位，默认:true
                timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                buttonOffset: new AMap.Pixel(-40, -40),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                buttonPosition: 'RB'
            });
            map.addControl(geolocation);
            geolocation.getCurrentPosition();
            AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
            AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
        });
        //解析定位结果
        function onComplete(data) {

            var str = ['定位成功'];
            str.push('经度：' + data.position.getLng());
            str.push('纬度：' + data.position.getLat());
            if (data.accuracy) {
                str.push('精度：' + data.accuracy + ' 米');
            }//如为IP精确定位结果则没有精度信息
            str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
            console.log(str);

            $("#mapContainer").attr("data-longitude", data.position.getLng());
            $("#mapContainer").attr("data-latitude", data.position.getLat());

            //显示附近商家
            ShakeNearShop();

        }
        //解析定位错误信息
        function onError(data) {
            console.log('定位失败');
        }
        map.on('complete', function () {
            $('.amap-logo').css('visibility', 'hidden');
            $('.amap - copyright').css('visibility', 'hidden');
        });

        //搜索附近商家
        function ShakeNearShop() {

            var longitude = $("#mapContainer").attr("data-longitude");
            var latitude = $("#mapContainer").attr("data-latitude");

            if (longitude == null || longitude == 0 || longitude == undefined || latitude == null || latitude == 0 || latitude == undefined) {
                return;
            }

            $.ajax({
                type: "POST",
                dataType: "json",
                url: '@Url.Action("ShakeNearShop", "Home")',
                data: {
                    Longitude: longitude,
                    Latitude: latitude,
                    NearDistance: 1000
                },
                success: function (data) {
                    console.log(data);
                    if (data.Status && data.Data.length > 0) {

                        //清除原有店铺标记
                        if (shopmakerlist != null || shopmakerlist.length > 0) {
                            for (var i = 0; i < shopmakerlist.length; i++) {
                                map.remove(shopmakerlist[i]);
                            }
                            shopmakerlist = [];
                        }
                        //添加店铺标记并展示地图
                        for (var i = 0; i < data.Data.length; i++) {
                            setshopmarker(data.Data[i].ShopName, data.Data[i].Longitude, data.Data[i].Latitude);
                        }
                    }

                },
                error: function (error) {
                    $(this).EaLoading("destroy");
                    toast("Ajax send error");
                }
            });
        }

        //在地图上设置标注
        function setshopmarker(markertitle, lng, lat) {

            $("#markicontitle").html(markertitle);
            var content = $("#markicon").html();
            var marker = new AMap.Marker({
                content: content,
                position: new AMap.LngLat(lng, lat),   // 经纬度对象，也可以是经纬度构成的一维数组[116.39, 39.9]
                title: markertitle,
                offset: new AMap.Pixel(-36, -110) // 相对于基点的偏移位置
            });
            shopmakerlist.push(marker);
            map.add(marker);
        }
    </script>

}