@using EarlySite.Model.Show;
@using EarlySite.Model.Common;
@using EarlySite.Model.Enum;

@{
    ViewBag.Title = "首页";
}
<div class="header-banner">
    <a href="https://www.bilibili.com/blackboard/join-list.html" target="_blank" class="banner-href"></a>

</div>

<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <div id="mapContainer" class="row corner" style="height:0px;padding-bottom:40%">
            </div>
        </div>
    </div>
    <div class="row corner">
        <div class="warrper">
            <div class="warrper-header">
                <a class="warrper-header-title efont" href="">今日食</a>
            </div>
            <div class="warrper-body">
                @{
                    Html.RenderPartial("TodayDishPartialView");
                }
            </div>
        </div>


    </div>



    <div class="row corner">

        <div class="warrper">
            <div class="warrper-header">
                <a class="warrper-header-title efont" href="">推荐单品</a>
                <span class="warrper-header-more"><a href="" class="efont">更多</a></span>
            </div>
            <div class="warrper-body">
                @{
                    Html.RenderPartial("PushDishInfoPartialView", (PageList<Dish>)ViewBag.DishList);
                }
            </div>
        </div>

        <div class="warrper">
            <div class="warrper-header">
                <a class="warrper-header-title efont" href="">推荐食谱</a>
                <span class="warrper-header-more"><a href="" class="efont">更多</a></span>
            </div>
            <div class="warrper-body">
                @{
                    Html.RenderPartial("PushRecipesInfoPartialView", (PageList<Recipes>)ViewBag.RecipesList);
                }
            </div>
        </div>
    </div>


</div>

<div id="markicon" hidden="hidden">
    <div class="MakerIcon">
        <div class="MakerIcon-svg">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="32px" height="37px" viewBox="0 0 32 37" enable-background="new 0 0 32 37" xml:space="preserve">
            <image id="restaruntimg" width="32" height="37" x="0" y="0" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAlCAMAAAAUaRt1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABU1BMVEVERER+VfxERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERGRkZCQkJDQ0NEREQ/Pz84ODhFRUVcTI10Ut1+Vfw3NzdBQUH///+MZ/y1nf3Lu/7Esf6hg/24of36+f/r5f/k2/739f+Sb/yGX/zi2f78+//Cr/7Yy/7It/65o/2tk/308f/x7f+AWfKbe/2ihf2wl/2HYvKfgvV9VfHHtf7h1/7Rw/7bz/79/f+Vc/3w6/+BW/KLaPOrkvbQwf7u6f+7pf328//k3Px7U/Gzm/3Zzf7Wyf7q4/+8p/2cff2vlf2ymf3c0f7Ov/6AV/zl3f6/q/57UvGqj/2Qbfzo4f7Kuf6ni/3e0/6HYfxAQEA5OTlhTKPC4584AAAAIHRSTlMAAAEEBwwPEhMFCxshJCYVIy00ODk6Ki4zFBgfJzAyFlZFILoAAAABYktHRCy63XGrAAAAB3RJTUUH4ggCDTonhVprIgAAAhJJREFUOMt9lOlX2kAUxYdASAgJAhFRBOlkRB15LZGlrWApttVWhba2avcN6WIXm///U9+EBE1ZLgfOnPd+85KZcy+ESOGIHFXUMSlRORKWCJFimhrXjcSYDD2uajGJhLW5ZCptTlA6lZzTwiSiJs0b1KLMohZjzPKEy9WSmVQjRI6n1tY3+ARtrG+m4jKJ6mk6sY9EOa1HiWKYFp+iNdNQiJow2TTAMhPqTIB5gMUBP0I3b1Uq9pa7tAGuTfCAag3qjdvQuINrGAfubjft1k7jXrtRuz8R2OlUd7H8gEOl+dAFgu/wCPZg/zGW+ZODw8PABLwHLB9td/F3H7/Qq8JTOzBBAM/snnjT57gVWrU9PMZ/E5otOEbghQBenpyKWhA4a8GrY4DX4ogHZ2+uA8wF3r57LzaL+4AP8HF8wqfmZx/40q+fjwPng8bXngC+1dvwXcwZnWL4CP5j96Td7cCF/RNaPAAMJ+BdH8FF3+52Or/4EPAfQT2A863+YPD79A/nwQl0pmHQcjMMg5ZD017ONC3a/u8021NhexGczVXMCXOueo7FLEapGxwvevOZjDUiHJrJzPvR88O7kF30CYctZhdG4fXiv5RbzheoM9xfyC/nlvz4C4VCISkm54xsGQnnMmvk5JiEReIr5BOFsuOUC37/CnAliMRKqbSSEH0yQUgU9XxeL07pu/9GSrGoaIH+P1kOlu2G3pFFAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTA4LTAyVDEzOjU4OjM5KzA4OjAw0d1K+AAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0wOC0wMlQxMzo1ODozOSswODowMKCA8kQAAABDdEVYdHNvZnR3YXJlAC91c3IvbG9jYWwvaW1hZ2VtYWdpY2svc2hhcmUvZG9jL0ltYWdlTWFnaWNrLTcvL2luZGV4Lmh0bWy9tXkKAAAAGHRFWHRUaHVtYjo6RG9jdW1lbnQ6OlBhZ2VzADGn/7svAAAAF3RFWHRUaHVtYjo6SW1hZ2U6OkhlaWdodAAzN1ieDHsAAAAWdEVYdFRodW1iOjpJbWFnZTo6V2lkdGgAMzLQWzh5AAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADEzMTEwNzkxOTLTYxLOAAAAEXRFWHRUaHVtYjo6U2l6ZQAxMzM3QsF2S7AAAABgdEVYdFRodW1iOjpVUkkAZmlsZTovLy9ob21lL3d3d3Jvb3QvbmV3c2l0ZS93d3cuZWFzeWljb24ubmV0L2Nkbi1pbWcuZWFzeWljb24uY24vc3JjLzU1MzQvNTUzNDYzLnBuZ7wnzuQAAAAASUVORK5CYII=" />
            </svg>
        </div>
        <span class="MakerIcon-lable" id="markicontitle">测试商家</span>
    </div>
</div>


<div id="foodicon" hidden="hidden">
    <div class="MakerIcon">
        <div class="MakerIcon-svg">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="32px" height="37px" viewBox="0 0 32 37" enable-background="new 0 0 32 37" xml:space="preserve">
            <image id="foodimg" width="32" height="37" x="0" y="0" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAlCAMAAAAUaRt1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAApVBMVEUAAABEREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREQ4ODg/Pz9ERERDQ0NCQkJGRkY3NzdcTI10Ut1+VfxFRUVBQUH///+pjf2ae/zUxv7w7P7Fs/2pjv3i2f63oP1AQEA5OTlhTKO4Cxy1AAAAH3RSTlMAAQQHDA8SEwULGyEkJhUjLTQ4OToqLjMUGB8nMDIWJMQUUQAAAAFiS0dEKyS55AgAAAAHdElNRQfiCAIODDsaARhBAAABd0lEQVQ4y4WU2XqCMBCFw76XRUQRRJPUjU1LLe//aCVIWCS05+NCOX+GYZwjABwviJKszCRLosBzAHCqpuiGac1kGrqiqRzgtQ/bcT2GXMf+0HggKLZ3OEIIUSfyESOIEf70bEUAou6czpcrQ5fzzdFFIBluyvQbAruGBGTTu41uZtnoC/JMGSiWh5YA6FkKAWB/J281A2iFosxalUX/iAlQZL0KVoXiPgD3gtHDIxuLUSGbA2hcoZwC5azJ/4B8qq92GmMgm2k+hys51V50mO+TJKeyvGpOV9f5W1CANrgAfDenl3+sahgRu0JO/McIwO9vQYD8HWhWrl+Yqu+f9tCs3F9L+yRL26w9Xlr7H7L2JDgYQwRRPXh1kx54PLXB6aK38n3cEzXy/RWNHg3vOtjAmvqbYN2Ht4v/NtxF8atGjeNoF25p/DtxqhiawbMh6jQwQ1EdrDERp3Wdxkz/RVj7w2Fvsf2WSIwoMpIFv/03kpNE1ib+LyF8guYaLSDrAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE4LTA4LTAyVDE0OjEyOjU5KzA4OjAwzTqmbAAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOC0wOC0wMlQxNDoxMjo1OSswODowMLxnHtAAAABDdEVYdHNvZnR3YXJlAC91c3IvbG9jYWwvaW1hZ2VtYWdpY2svc2hhcmUvZG9jL0ltYWdlTWFnaWNrLTcvL2luZGV4Lmh0bWy9tXkKAAAAGHRFWHRUaHVtYjo6RG9jdW1lbnQ6OlBhZ2VzADGn/7svAAAAF3RFWHRUaHVtYjo6SW1hZ2U6OkhlaWdodAAzN1ieDHsAAAAWdEVYdFRodW1iOjpJbWFnZTo6V2lkdGgAMzLQWzh5AAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADEzMTEwNzkxMDICoamHAAAAEHRFWHRUaHVtYjo6U2l6ZQA3MThC/Ui8kAAAAGB0RVh0VGh1bWI6OlVSSQBmaWxlOi8vL2hvbWUvd3d3cm9vdC9uZXdzaXRlL3d3dy5lYXN5aWNvbi5uZXQvY2RuLWltZy5lYXN5aWNvbi5jbi9zcmMvNTUzMi81NTMyNDgucG5nCtLOJAAAAABJRU5ErkJggg==" />
            </svg>
        </div>
        <span class="MakerIcon-lable" id="markicontitle">测试食物</span>
    </div>
</div>

@section scripts
{

    <script type="text/javascript">

        //店铺标记集合
        var shopmakerlist = [];
        //地图显示图层
        var features = [];

        var scale = new AMap.Scale({
            visible: false
        }),
            toolBar = new AMap.ToolBar({
                visible: false
            }),
            overView = new AMap.OverView({
                visible: false
            }),
            map = new AMap.Map("mapContainer", {
                resizeEnable: true
            });

        features.push("bg");
        features.push("road");

        map.setFeatures(features);
        map.addControl(scale);
        map.addControl(toolBar);
        map.addControl(overView);
        var geolocation;

        map.plugin('AMap.Geolocation', function () {
            geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,//是否使用高精度定位，默认:true
                timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                buttonOffset: new AMap.Pixel(-40, -40),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                buttonPosition: 'RB'
            });
            map.addControl(geolocation);
            geolocation.getCurrentPosition();
            AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
            AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
        });
        //解析定位结果
        function onComplete(data) {

            var str = ['定位成功'];
            str.push('经度：' + data.position.getLng());
            str.push('纬度：' + data.position.getLat());
            if (data.accuracy) {
                str.push('精度：' + data.accuracy + ' 米');
            }//如为IP精确定位结果则没有精度信息
            str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
            console.log(str);

            $("#mapContainer").attr("data-longitude", data.position.getLng());
            $("#mapContainer").attr("data-latitude", data.position.getLat());

            //显示附近商家
            ShakeNearShop();

        }
        //解析定位错误信息
        function onError(data) {
            console.log('定位失败');
        }
        map.on('complete', function () {
            $('.amap-logo').css('visibility', 'hidden');
            $('.amap-copyright').css('visibility', 'hidden');
        });

        //搜索附近商家
        function ShakeNearShop() {

            var longitude = $("#mapContainer").attr("data-longitude");
            var latitude = $("#mapContainer").attr("data-latitude");

            if (longitude == null || longitude == 0 || longitude == undefined || latitude == null || latitude == 0 || latitude == undefined) {
                return;
            }

            $.ajax({
                type: "POST",
                dataType: "json",
                url: '@Url.Action("ShakeNearShop", "Home")',
                data: {
                    Longitude: longitude,
                    Latitude: latitude,
                    NearDistance: 1000
                },
                success: function (data) {
                    console.log(data);
                    if (data.Status && data.Data.length > 0) {

                        //清除原有店铺标记
                        if (shopmakerlist != null || shopmakerlist.length > 0) {
                            for (var i = 0; i < shopmakerlist.length; i++) {
                                map.remove(shopmakerlist[i]);
                            }
                            shopmakerlist = [];
                        }
                        //添加店铺标记并展示地图
                        for (var i = 0; i < data.Data.length; i++) {
                            setshopmarker(data.Data[i].ShopName, data.Data[i].Longitude, data.Data[i].Latitude);
                        }
                    }

                },
                error: function (error) {
                    console.log(error);
                    $(this).EaLoading("destroy");
                    toast("Ajax send error" + error);
                }
            });
        }

        //在地图上设置标注
        function setshopmarker(markertitle, lng, lat) {

            $("#markicontitle").html(markertitle);
            var content = $("#markicon").html();
            var marker = new AMap.Marker({
                content: content,
                position: new AMap.LngLat(lng, lat),   // 经纬度对象，也可以是经纬度构成的一维数组[116.39, 39.9]
                title: markertitle,
                offset: new AMap.Pixel(-40, -85) // 相对于基点的偏移位置
            });
            shopmakerlist.push(marker);
            map.add(marker);
        }
    </script>

}